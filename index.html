<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Liverpool W/D/L â€” Sep 27, 2025 â†’ Today</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

  <style>
    /* --- Dark theme (forced) --- */
    :root {
      --bg: #0b0c0f;
      --card: #101218;
      --fg: #e5e7eb;
      --muted: #9aa0a6;
      --border: #22252d;
      --shadow: 0 10px 32px rgba(0,0,0,.45);
      --radius: 14px;
    }
    html, body { height: 100%; background: var(--bg); color: var(--fg); }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }
    .wrap { max-width: 1100px; margin: 0 auto; padding: clamp(12px, 3.5vw, 24px); }
    header { margin: 0 0 12px; }
    h1 { margin: 0; font-size: clamp(20px, 4.5vw, 28px); line-height: 1.2; }
    .muted { color: var(--muted); }
    .tag { display:inline-block; padding:2px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; color: var(--muted); }

    .grid { display: grid; gap: clamp(12px, 2.6vw, 18px); grid-template-columns: 1fr; }
    @media (min-width: 900px) { .grid { grid-template-columns: 2fr 1fr; } }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: clamp(12px, 3vw, 18px);
    }

    /* Chart area with fluid height for mobile */
    .chart-wrap { position: relative; width: 100%; aspect-ratio: 16 / 10; min-height: 240px; max-height: 560px; }
    canvas { width: 100% !important; height: 100% !important; }

    .stats { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-top: 8px; font-size: 14px; }
    .stat b { font-size: 18px; }

    table { width:100%; border-collapse: collapse; margin-top: 10px; }
    thead th {
      text-align:left; font-weight:600; font-size: 13px; color: var(--muted);
      border-bottom: 1px solid var(--border); padding: 8px 10px;
    }
    tbody td {
      border-bottom: 1px solid var(--border); padding: 10px; font-size: 14px;
    }
    tbody tr:hover { background: rgba(255,255,255,0.02); }
    .r { text-align:center; font-weight:700; }
    .w { color: #10b981; } /* win */
    .d { color: #9ca3af; } /* draw grey (matches bar) */
    .l { color: #ef4444; } /* loss */

    .foot { margin-top: 8px; color: var(--muted); font-size: 13px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ðŸ”´ Liverpool Gambling Les go<span class="tag">All competitions</span></h1>
      <div class="muted" id="window">Date: <b>2025-09-27</b> â†’ <b id="today">today</b></div>
    </header>

    <div class="grid">
      <!-- Chart + stats -->
      <section class="card" aria-label="WDL chart">
        <div class="chart-wrap">
          <canvas id="wdlChart" aria-label="Wins, Draws, Losses bar chart" role="img"></canvas>
        </div>

        <div class="stats">
          <div class="stat">Taro Packs: <b id="wins">â€“</b></div>
          <div class="stat">Draws: <b id="draws">â€“</b></div>
          <div class="stat">Sci Center: <b id="losses">â€“</b></div>
          <div class="stat">Matches: <b id="matches">â€“</b></div>
          <div class="stat">Win%: <b id="winpct">â€“</b></div>
        </div>

        <div class="foot" id="meta">Loadingâ€¦</div>
      </section>

      <!-- Match history -->
      <aside class="card" aria-label="Match history">
        <h3 style="margin:0 0 8px; font-size:16px;">Match history</h3>
        <table id="tbl">
          <thead>
            <tr>
              <th style="width:96px">Date</th>
              <th>Competition</th>
              <th>Match</th>
              <th style="width:72px">Score</th>
              <th style="width:48px">R</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </aside>
    </div>
  </div>

  <script>
    // ----- Config
    const FROM = "2025-09-27";                 // fixed start
    const DATA_URL = "./data/fixtures.json";   // written daily by your workflow

    // ----- Helpers
    const pad = n => String(n).padStart(2, "0");
    const todayISO = () => { const d = new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; };
    document.getElementById("today").textContent = todayISO();

    let chart; // global Chart.js instance

    async function loadImage(src) {
      return new Promise(resolve => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => resolve(null);
        img.src = src + (src.includes("?") ? "" : `?v=${Date.now()}`); // cache-bust
      });
    }

    async function createChart(w, d, l) {
      const ctx = document.getElementById("wdlChart").getContext("2d");

      // separate images per bar
      const winImg  = await loadImage("./assets/wins.png");
      const lossImg = await loadImage("./assets/losses.png");

      const winFill  = winImg  ? ctx.createPattern(winImg,  "repeat") : "#2dd4bf";
      const drawFill = "#9ca3af"; // solid grey for draws
      const lossFill = lossImg ? ctx.createPattern(lossImg, "repeat") : "#ef4444";

      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: ["Taro Packs", "Draws", "Sci Center"],
          datasets: [{
            label: "Results",
            data: [w, d, l],
            borderColor: "rgba(255,255,255,.18)",
            borderWidth: 1,
            backgroundColor: [winFill, drawFill, lossFill],
            hoverBackgroundColor: [winFill, drawFill, lossFill],
            maxBarThickness: 76
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: { top: 6, right: 6, bottom: 6, left: 6 } },
          scales: {
            x: { ticks: { color: "#cbd5e1", font: { size: 12 } }, grid: { display: false } },
            y: { beginAtZero: true, ticks: { color: "#cbd5e1", precision: 0, font: { size: 12 } }, grid: { color: "rgba(255,255,255,.06)" } }
          },
          plugins: { legend: { display: false } },
          animation: { duration: 250 }
        }
      });
    }

    async function loadAndRender() {
        const meta = document.getElementById("meta");
        meta.textContent = "Loadingâ€¦";

        // âœ… cache-bust GitHub Pages CDN
        const url = `${DATA_URL}${DATA_URL.includes("?") ? "&" : "?"}v=${Date.now()}`;

        try {
        const res = await fetch(url, { cache: "no-store" });

        if (!res.ok) {
            // Show HTTP status to help debug (403/404/500 etc.)
            meta.textContent = `Error loading fixtures.json (HTTP ${res.status})`;
            console.error("fetch error", res.status, res.statusText, await res.text());
            return;
        }

        let data;
        try {
            data = await res.json();
        } catch (parseErr) {
            meta.textContent = "Error parsing fixtures.json (invalid JSON)";
            console.error("parse error", parseErr);
            return;
        }

        const rows = Array.isArray(data.rows) ? data.rows : [];
        const w = data.summary ? (data.summary.wins ?? 0)  : rows.filter(r => r.result === "W").length;
        const d = data.summary ? (data.summary.draws ?? 0) : rows.filter(r => r.result === "D").length;
        const l = data.summary ? (data.summary.losses ?? 0): rows.filter(r => r.result === "L").length;

        // stats
        document.getElementById("wins").textContent = w;
        document.getElementById("draws").textContent = d;
        document.getElementById("losses").textContent = l;
        const matches = w + d + l;
        document.getElementById("matches").textContent = matches;
        document.getElementById("winpct").textContent = matches ? ((w / matches) * 100).toFixed(1) + "%" : "â€”";

        // window/meta
        const from = data.from || FROM;
        const to   = data.to   || (new Date()).toISOString().slice(0,10);
        const gen  = data.generated_at || "â€”";
        document.getElementById("window").innerHTML = `Window: <b>${from}</b> â†’ <b>${to}</b>`;
        meta.textContent = `Updated ${gen}. Source: ESPN results.`;

        // table
        const tbody = document.querySelector("#tbl tbody");
        tbody.innerHTML = "";
        rows.forEach(r => {
            const tr = document.createElement("tr");
            const tdDate = document.createElement("td"); tdDate.textContent = r.date || ""; tdDate.style.whiteSpace = "nowrap";
            const tdComp = document.createElement("td"); tdComp.textContent = r.competition || "â€”";
            const tdMatch= document.createElement("td"); tdMatch.textContent = `${r.home} vs ${r.away}`;
            const tdScore= document.createElement("td"); tdScore.textContent = r.score_text || "â€”"; tdScore.style.textAlign = "center";
            const tdRes  = document.createElement("td"); tdRes.textContent = r.result || ""; tdRes.className = "r " + (r.result ? r.result.toLowerCase() : "");
            tr.append(tdDate, tdComp, tdMatch, tdScore, tdRes);
            tbody.appendChild(tr);
        });

        // chart
        await createChart(w, d, l);

        } catch (e) {
        meta.textContent = "Error loading fixtures.json (network)";
        console.error(e);
    }
    }

    loadAndRender();
  </script>
</body>
</html>
